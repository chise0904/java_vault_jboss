#!/bin/bash
## -*- shell-script -*- ######################################################
##                                                                          ##
##  WildFly standalone 啟動配置檔案                                          ##
##                                                                          ##
##  此檔案用於設定 JVM 參數和環境變數                                         ##
##  路徑: $JBOSS_HOME/bin/standalone.conf                                   ##
##                                                                          ##
##############################################################################

## JVM 記憶體設定
JAVA_OPTS="-Xms512m -Xmx2048m"

## JVM 性能調優參數
JAVA_OPTS="$JAVA_OPTS -XX:MetaspaceSize=256m"
JAVA_OPTS="$JAVA_OPTS -XX:MaxMetaspaceSize=512m"
JAVA_OPTS="$JAVA_OPTS -Djava.net.preferIPv4Stack=true"

## JVM GC 設定
JAVA_OPTS="$JAVA_OPTS -XX:+UseG1GC"
JAVA_OPTS="$JAVA_OPTS -XX:+UseStringDeduplication"

## ========================================================================
## 應用程式環境變數設定 (使用 -D 參數)
## ========================================================================

## 方法 1: 使用 System Properties (推薦)
JAVA_OPTS="$JAVA_OPTS -DAPP_NAME='JBoss Demo Application'"
JAVA_OPTS="$JAVA_OPTS -DAPP_VERSION='1.0.0'"
JAVA_OPTS="$JAVA_OPTS -DAPP_ENVIRONMENT='production'"
JAVA_OPTS="$JAVA_OPTS -DDATABASE_URL='jdbc:postgresql://localhost:5432/demodb'"
JAVA_OPTS="$JAVA_OPTS -DAPI_KEY='demo-api-key-12345'"

## 資料庫連線設定
JAVA_OPTS="$JAVA_OPTS -DDB_HOST='localhost'"
JAVA_OPTS="$JAVA_OPTS -DDB_PORT='5432'"
JAVA_OPTS="$JAVA_OPTS -DDB_NAME='demodb'"
JAVA_OPTS="$JAVA_OPTS -DDB_USER='dbuser'"
# 注意: 生產環境不要在此設定密碼，請使用 vault 或 secret management

## 日誌設定
JAVA_OPTS="$JAVA_OPTS -Dlogging.level='INFO'"
JAVA_OPTS="$JAVA_OPTS -Dlog.path='/var/log/wildfly'"

## ========================================================================
## 方法 2: 使用 Shell 環境變數
## ========================================================================

## 設定 Shell 環境變數（這些會被 Java 應用程式的 System.getenv() 讀取）
export APP_NAME="JBoss Demo Application"
export APP_VERSION="1.0.0"
export APP_ENVIRONMENT="production"
export DATABASE_URL="jdbc:postgresql://localhost:5432/demodb"
export API_KEY="demo-api-key-12345"

## ========================================================================
## WildFly 特定設定
## ========================================================================

## WildFly 管理介面
JAVA_OPTS="$JAVA_OPTS -Djboss.bind.address=0.0.0.0"
JAVA_OPTS="$JAVA_OPTS -Djboss.bind.address.management=0.0.0.0"

## WildFly 資料目錄
# JAVA_OPTS="$JAVA_OPTS -Djboss.server.data.dir=/var/wildfly/data"

## 啟用 JMX 遠端監控（開發環境使用）
# JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote"
# JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote.port=9999"
# JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote.authenticate=false"
# JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote.ssl=false"

## ========================================================================
## 安全性設定
## ========================================================================

## 啟用 Security Manager（生產環境建議）
# SECMGR="true"

## ========================================================================
## 除錯設定（開發環境使用）
## ========================================================================

## 啟用遠端除錯
# DEBUG_MODE="true"
# DEBUG_PORT="8787"

## 如果需要除錯，取消下面的註解
# JAVA_OPTS="$JAVA_OPTS -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:8787"

## ========================================================================
## 效能監控和診斷
## ========================================================================

## 啟用 GC 日誌
# JAVA_OPTS="$JAVA_OPTS -Xlog:gc*:file=/var/log/wildfly/gc.log:time,uptime:filecount=5,filesize=10M"

## 當 OOM 時產生 heap dump
JAVA_OPTS="$JAVA_OPTS -XX:+HeapDumpOnOutOfMemoryError"
JAVA_OPTS="$JAVA_OPTS -XX:HeapDumpPath=/tmp/wildfly-heapdump.hprof"

## ========================================================================
## 輸出設定資訊（除錯用）
## ========================================================================
echo "=========================================="
echo "WildFly Configuration"
echo "=========================================="
echo "JAVA_OPTS: $JAVA_OPTS"
echo "APP_NAME: $APP_NAME"
echo "APP_VERSION: $APP_VERSION"
echo "=========================================="
